<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scadenze Auto & Moto – Italia</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="icon" href="icon-192.png">
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --border:#1f2a44; --text:#e8eef9; --muted:#9fb2d1;
      --brand:#0ea5e9; --focus:#2563eb; --ok:#1e5f36; --soon:#5f4a1e; --danger:#5f1e29;
    }
    [data-theme="rosa"] { --brand:#ec4899; --focus:#db2777; }
    [data-theme="verde"] { --brand:#22c55e; --focus:#16a34a; }
    [data-theme="scuro"] { --bg:#0a0a0a; --card:#141414; --border:#242424; --text:#f2f2f2; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:6px 0 12px} h2{font-size:18px;margin:0 0 8px;color:#93c5fd}
    label{display:block;font-size:14px;margin:8px 0 4px;color:#c0cff4}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #253453;background:#0f1626;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--focus);border-color:var(--focus)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{cursor:pointer;background:var(--focus);border:none} .btn:hover{filter:brightness(.95)}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f2a3a;border:1px solid #1e3a5f;color:#9bd1ff;font-size:12px;margin-right:6px}
    .danger{background:#3a0f16;border-color:var(--danger);color:#ff9bb0}
    .ok{background:#103a1c;border-color:var(--ok);color:#9bffc0}
    .soon{background:#3a2a0f;border-color:var(--soon);color:#ffe39b}
    .muted{color:#9fb2d1;font-size:12px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .space{height:8px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px}
    .footer{opacity:.7;font-size:12px;margin-top:20px}
    .toolbar{position:sticky;top:0;z-index:10;background:var(--bg);padding:8px 0;margin:-8px 0 8px 0}
    .status{display:flex;align-items:center;gap:12px}
    .dot{width:14px;height:14px;border-radius:50%}
    .dot.ok{background:#16a34a} .dot.warn{background:#f59e0b} .dot.danger{background:#ef4444}
    dialog::backdrop{background-color:rgba(0,0,0,.6)}
    dialog{border:none;border-radius:16px;background:var(--card);color:var(--text);padding:0;max-width:560px;width:92%}
    .modal-header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:bold}
    .modal-body{padding:16px}
    .modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
    @media print {
      body{background:#fff;color:#000}
      .no-print{display:none !important}
      .card{box-shadow:none;border:1px solid #ddd}
    }
  </style>
</head>
<body data-theme="blu">
  <div class="container">
    <div class="toolbar card no-print">
      <div class="actions">
        <button class="btn" id="btn-perm">Attiva notifiche</button>
        <button class="btn" id="btn-export-ics">Esporta .ics (tutte)</button>
        <button class="btn" id="btn-backup">Esporta dati (.json)</button>
        <input type="file" id="file-restore" accept="application/json" style="display:none" />
        <button id="btn-restore">Importa dati</button>
        <button id="btn-export-pdf">Stampa / PDF</button>
        <button id="btn-onboarding">Guida</button>
        <button id="btn-about">About</button>
        <div style="flex:1"></div>
        <select id="theme" title="Tema">
          <option value="blu" selected>Tema Blu</option>
          <option value="rosa">Tema Rosa</option>
          <option value="verde">Tema Verde</option>
          <option value="scuro">Tema Scuro</option>
        </select>
      </div>
    </div>

    <h1>Scadenze Auto & Moto – Italia</h1>

    <!-- Dashboard -->
    <div class="card" id="dashboard">
      <h2>Stato generale</h2>
      <div class="status">
        <div id="status-dot" class="dot ok"></div>
        <div id="status-text">Tutto ok</div>
        <div style="flex:1"></div>
        <div class="small muted" id="status-extra"></div>
      </div>
    </div>

    <div class="card">
      <h2>Aggiungi veicolo</h2>
      <div class="row">
        <div>
          <label>Nome veicolo (scegli dalla lista o scrivi)</label>
          <!-- TENDINA + SCRITTURA LIBERA -->
          <input id="name" list="vehicle-list" placeholder="Es. Fiat Panda 1.2">
          <datalist id="vehicle-list">
            <!-- Marche e modelli comuni (esempi, puoi ampliare in futuro) -->
            <option>Fiat Panda 1.2</option><option>Fiat 500 1.0</option><option>Fiat Punto 1.3 MJT</option>
            <option>Fiat Tipo 1.6 MJT</option><option>Lancia Ypsilon 1.2</option>
            <option>Volkswagen Golf 1.6 TDI</option><option>Volkswagen Polo 1.0</option><option>Volkswagen Tiguan 2.0 TDI</option>
            <option>Volkswagen Up! 1.0</option><option>Audi A3 1.6 TDI</option><option>Audi A4 2.0 TDI</option>
            <option>BMW Serie 1 118d</option><option>BMW Serie 3 320d</option><option>Mercedes A 180d</option>
            <option>Mercedes C 220d</option><option>Peugeot 208 1.2</option><option>Peugeot 308 1.5 BlueHDi</option>
            <option>Renault Clio 1.0</option><option>Renault Captur 1.5 dCi</option><option>Dacia Duster 1.5 dCi</option>
            <option>Toyota Yaris 1.5 Hybrid</option><option>Toyota Corolla 1.8 Hybrid</option>
            <option>Hyundai i20 1.2</option><option>Hyundai Tucson 1.6</option><option>Kia Sportage 1.6</option>
            <option>Opel Corsa 1.2</option><option>Opel Astra 1.5</option>
            <option>Ford Fiesta 1.0</option><option>Ford Focus 1.5 EcoBlue</option><option>Ford Puma 1.0 EcoBoost</option>
            <option>Nissan Qashqai 1.5 dCi</option><option>Nissan Micra 1.0</option>
            <option>Jeep Renegade 1.6 MJT</option><option>Jeep Compass 1.6 MJT</option>
            <option>Alfa Romeo Giulia 2.2</option><option>Alfa Romeo Stelvio 2.2</option>
            <option>Piaggio Vespa 125</option><option>Yamaha MT-07</option><option>Honda SH 125</option>
            <option>Honda CB500F</option><option>BMW R1200GS</option><option>Ducati Monster 821</option>
          </datalist>
        </div>
        <div>
          <label>Targa (opzionale)</label>
          <input id="plate" placeholder="Es. AB123CD">
        </div>
      </div>
      <div class="row-3">
        <div>
          <label>Tipo</label>
          <select id="type">
            <option>Auto</option><option>Moto</option><option>Furgone</option><option>Altro</option>
          </select>
        </div>
        <div>
          <label>Km attuali (opzionale)</label>
          <input id="km" type="number" min="0" placeholder="Es. 124500">
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn" id="addVehicle">Aggiungi</button>
        </div>
      </div>
      <p class="muted small">I dati restano sul tuo dispositivo (LocalStorage). Nessun server, nessun tracciamento.</p>
    </div>

    <div class="card">
      <h2>Veicoli</h2>
      <div id="vehicles"></div>
    </div>

    <div class="card">
      <h2>Calcolo Bollo (stima per Regione)</h2>
      <div class="row-3">
        <div>
          <label>kW</label>
          <input id="bollo-kw" type="number" min="1" placeholder="Es. 81">
        </div>
        <div>
          <label>Regione</label>
          <!-- SOLO REGIONE: tariffa si compila da sola -->
          <select id="bollo-regione">
            <option value="">Seleziona Regione</option>
            <option>Abruzzo</option><option>Basilicata</option><option>Calabria</option><option>Campania</option>
            <option>Emilia-Romagna</option><option>Friuli-Venezia Giulia</option><option>Lazio</option><option>Liguria</option>
            <option>Lombardia</option><option>Marche</option><option>Molise</option><option>Piemonte</option>
            <option>Puglia</option><option>Sardegna</option><option>Sicilia</option><option>Toscana</option>
            <option>Trentino-Alto Adige</option><option>Umbria</option><option>Valle d'Aosta</option><option>Veneto</option>
          </select>
        </div>
        <div>
          <label>Tariffa €/kW (auto)</label>
          <input id="bollo-tariff" type="number" step="0.01" placeholder="auto" disabled>
          <div class="small muted">
            Di default è impostata dalla Regione (stima). 
            <label style="display:block;margin-top:6px;">
              <input type="checkbox" id="bollo-edit"> Inserimento manuale (opz.)
            </label>
          </div>
        </div>
      </div>
      <p class="muted small">
        Nota: il bollo reale dipende anche da classe ambientale, anzianità, potenza sopra/sotto soglia, eventuali sconti regionali. 
        Qui è una <strong>stima di base</strong> per semplificare.
      </p>
      <div style="margin:8px 0">
        <button class="btn" id="bollo-calc">Calcola</button>
      </div>
      <div id="bollo-result" class="small"></div>
    </div>

    <div class="card no-print">
      <h2>Link utili / monetizzazione (personalizzabili)</h2>
      <div class="flex small">
        <a class="chip link" href="#" id="aff-tyres" target="_blank" rel="nofollow noopener">Pneumatici scontati</a>
        <a class="chip link" href="#" id="aff-oil" target="_blank" rel="nofollow noopener">Olio & filtri</a>
        <a class="chip link" href="#" id="aff-ins" target="_blank" rel="nofollow noopener">Preventivo RC auto</a>
      </div>
      <p class="muted small">Sostituisci gli URL con i tuoi link affiliati. Nessun costo.</p>
    </div>

    <div class="footer no-print">© 2025 Scadenze Auto & Moto – Italia. Tutti i diritti riservati.</div>
  </div>

  <!-- Onboarding -->
  <dialog id="dlg-onboarding">
    <div class="modal-header">Benvenuto!</div>
    <div class="modal-body">
      <p><strong>1) Installa l’app</strong>: menu del browser → “Installa app” / “Aggiungi a Home”.</p>
      <p><strong>2) Notifiche</strong>: premi “Attiva notifiche”, poi imposta i promemoria (30,7,0).</p>
      <p><strong>3) Calendario</strong>: “Aggiungi al Calendario” su ogni scadenza o “Esporta .ics (tutte)”.</p>
      <p><strong>4) Costi</strong>: inserisci il costo (vedi totale sul veicolo).</p>
      <p><strong>Backup</strong>: Esporta/Importa .json per salvare o trasferire.</p>
    </div>
    <div class="modal-footer"><button id="ob-close" class="btn">Ok, capito</button></div>
  </dialog>

  <!-- About -->
  <dialog id="dlg-about">
    <div class="modal-header">About</div>
    <div class="modal-body">
      <p><strong>Scadenze Auto & Moto – Italia</strong> v3.1 (PWA)</p>
      <p>© 2025 Scadenze Auto & Moto – Italia. Tutti i diritti riservati.</p>
      <p class="small">Fingerprint build: <code>PWA-v3.1</code></p>
      <p class="muted small">Software fornito senza licenza di riuso. Vietata la copia/distribuzione non autorizzata.</p>
    </div>
    <div class="modal-footer"><button id="about-close" class="btn">Chiudi</button></div>
  </dialog>

  <script>
    // ======= Stato & util =======
    const KEY = 'scadenzeapp:v3_1_pwa';
    const NOTIF_KEY = 'scadenzeapp:notified:v3_1_pwa';
    const state = JSON.parse(localStorage.getItem(KEY) || '{"vehicles":[],"theme":"blu","seenOnb":false}');
    const notified = JSON.parse(localStorage.getItem(NOTIF_KEY) || '{}');
    const $ = id => document.getElementById(id);
    const save = () => { localStorage.setItem(KEY, JSON.stringify(state)); localStorage.setItem(NOTIF_KEY, JSON.stringify(notified)); };
    const fmtDate = s => new Date(s).toLocaleDateString('it-IT', {day:'2-digit',month:'2-digit',year:'numeric'});
    const daysTo = s => Math.floor((new Date(s).setHours(0,0,0,0) - new Date().setHours(0,0,0,0))/(1000*60*60*24));
    const cur = n => (isNaN(n)||n===null)? '' : n.toLocaleString('it-IT', {style:'currency', currency:'EUR'});
    const el = (tag, attrs={}, children=[]) => { const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>k==='class'?n.className=v:n.setAttribute(k,v)); (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{ if(typeof c==='string') n.appendChild(document.createTextNode(c)); else n.appendChild(c); }); return n; };

    // ======= Notifiche locali =======
    async function askPerm(){
      if (!('Notification' in window)) { alert('Notifiche non supportate su questo dispositivo.'); return; }
      const perm = await Notification.requestPermission();
      if (perm === 'granted') new Notification('Notifiche attivate ✅', { body:'Riceverai promemoria quando l’app è aperta.' });
      else alert('Permesso notifiche negato o ignorato.');
    }
    async function notifyNow(title, body){
      try{ if (Notification.permission === 'granted') new Notification(title, { body, icon:'./icon-192.png' }); }catch(_){}
    }
    function checkNotifications(){
      if (Notification.permission !== 'granted') return;
      const todayISO = new Date().toISOString().slice(0,10);
      state.vehicles.forEach((v,vi)=>{
        (v.deadlines||[]).forEach((d,di)=>{
          const leads = Array.isArray(d.notifyDays)? d.notifyDays : (d.notifyDays? [d.notifyDays] : []);
          leads.forEach(lead=>{
            const dd = daysTo(d.when);
            const id = `${vi}::${(d.kind||'').replace(/:/g,'-')}::${d.when}::${di}::${lead}`;
            if (dd === lead || (dd < lead && dd >= 0 && notified[id] !== todayISO)) {
              notifyNow('Promemoria scadenza', `${d.kind} per ${v.name||v.plate||'veicolo'} scade il ${fmtDate(d.when)}`);
              notified[id] = todayISO;
            }
          });
        });
      });
      save();
    }

    // ======= Dashboard =======
    function computeStatus(){
      let late=0, soon=0, total=0;
      state.vehicles.forEach(v=>{
        (v.deadlines||[]).forEach(d=>{
          total++;
          const dd = daysTo(d.when);
          if (dd < 0) late++;
          else if (dd <= 14) soon++;
        });
      });
      const dot = $('status-dot'), text = $('status-text'), extra=$('status-extra');
      if (total===0){ dot.className='dot ok'; text.textContent='Aggiungi una scadenza'; extra.textContent=''; return; }
      if (late>0){ dot.className='dot danger'; text.textContent='Attenzione: scadenze passate'; extra.textContent=`Scadute: ${late}`; return; }
      if (soon>0){ dot.className='dot warn'; text.textContent='Scadenze in arrivo'; extra.textContent=`Entro 14 gg: ${soon}`; return; }
      dot.className='dot ok'; text.textContent='Tutto ok'; extra.textContent=`Totale scadenze: ${total}`;
    }

    // ======= Render veicoli =======
    function render(){
      computeStatus();
      const wrap = $('vehicles'); wrap.innerHTML = '';
      if (!state.vehicles.length) { wrap.appendChild(el('p',{class:'muted'},'Nessun veicolo. Aggiungine uno sopra.')); return; }
      state.vehicles.forEach((v,i) => {
        const card = el('div',{class:'card'});
        const costTotal = (v.deadlines||[]).reduce((s,d)=> s + (parseFloat(d.cost)||0), 0);
        card.appendChild(el('div',{class:'flex'},[
          el('h3',{}, v.name || 'Senza nome'),
          v.plate ? el('span',{class:'chip'}, v.plate) : null,
          el('span',{class:'chip'}, v.type || 'Auto'),
          v.km ? el('span',{class:'chip'}, `${v.km} km`) : null,
          el('span',{class:'chip'}, `Costi: ${cur(costTotal)||'€ 0,00'}`)
        ]));

        const list = el('div');
        (v.deadlines||[]).sort((a,b)=> new Date(a.when)-new Date(b.when)).forEach((d,idx) => {
          const dd = daysTo(d.when);
          const statusClass = dd < 0 ? 'danger' : dd <= 14 ? 'soon' : 'ok';
          const leads = Array.isArray(d.notifyDays)? d.notifyDays : (d.notifyDays? [d.notifyDays] : []);
          const row = el('div',{class:'row',style:'align-items:center;margin:8px 0;'});
          const leadsTxt = leads.length ? leads.sort((a,b)=>a-b).map(x=>x+'gg').join(', ') : '—';
          row.appendChild(el('div',{},[
            el('strong',{}, d.kind),
            el('div',{class:'muted small'}, `Scade il ${fmtDate(d.when)} (${dd} gg)`),
            d.note ? el('div',{class:'small'}, d.note) : null,
            (d.cost!=null && d.cost!=='') ? el('div',{class:'small'}, 'Costo: ' + cur(parseFloat(d.cost)||0)) : null,
            el('div',{class:'small muted'}, 'Promemoria: ' + leadsTxt)
          ]));
          const actions = el('div',{class:'actions'},[
            el('span',{class:`chip ${statusClass}`}, dd<0?'Scaduta': dd<=14?'In scadenza':'OK'),
            el('button',{class:'btn',onclick:()=>editDeadline(i,idx)},'Modifica'),
            el('button',{onclick:()=>removeDeadline(i,idx)},'Elimina'),
            el('button',{onclick:()=>setReminders(i,idx)}, 'Imposta promemoria'),
            el('button',{onclick:()=>exportOneICS(i,idx)},'Aggiungi al Calendario')
          ]);
          row.appendChild(actions);
          list.appendChild(row);
          list.appendChild(el('div',{class:'space'}));
        });
        card.appendChild(list);

        const form = el('div',{class:'row-3'});
        const kind = el('select'); ['Bollo','Revisione','Assicurazione (RCA)','Tagliando','Gomme','Altro'].forEach(k=>{ const opt=el('option'); opt.value=opt.textContent=k; kind.appendChild(opt); });
        const when = el('input',{type:'date'});
        const note = el('input',{placeholder:'Note (es. 5W30, 4L; officina; km prossimi 140k)'});
        const cost = el('input',{type:'number',step:'0.01',min:'0',placeholder:'Costo in € (opz.)'});
        const addBtn = el('button',{class:'btn'},'Aggiungi scadenza');
        addBtn.onclick = ()=>{
          if (!when.value) { alert('Inserisci una data.'); return; }
          v.deadlines = v.deadlines || [];
          v.deadlines.push({kind:kind.value, when: when.value, note: note.value||'', cost: cost.value||'', notifyDays: [30,7,0]});
          save(); render(); checkNotifications(); computeStatus();
        };
        form.appendChild(el('div',{},[el('label',{},'Tipo scadenza'), kind]));
        form.appendChild(el('div',{},[el('label',{},'Data'), when]));
        form.appendChild(el('div',{},[el('label',{},'Note (opzionale)'), note]));
        form.appendChild(el('div',{},[el('label',{},'Costo (opzionale)'), cost]));
        card.appendChild(form);
        card.appendChild(el('div',{class:'space'}));
        card.appendChild(addBtn);

        card.appendChild(el('div',{class:'space'}));
        const bar = el('div',{class:'actions'},[
          el('button',{onclick:()=>editVehicle(i)},'Modifica veicolo'),
          el('button',{onclick:()=>duplicateVehicle(i)},'Duplica'),
          el('button',{onclick:()=>removeVehicle(i)},'Elimina')
        ]);
        card.appendChild(el('div',{class:'space'}));
        card.appendChild(bar);

        wrap.appendChild(card);
      });
    }

    // ======= Mutazioni =======
    function addVehicle(){
      const name = $('name').value.trim();
      const plate = $('plate').value.trim().toUpperCase();
      const type = $('type').value;
      const km = parseInt($('km').value||'');
      state.vehicles.push({name, plate, type, km: isNaN(km)?null:km, deadlines:[]});
      save(); render();
      $('name').value=''; $('plate').value=''; $('km').value='';
      checkNotifications(); computeStatus();
    }
    function editVehicle(i){
      const v = state.vehicles[i];
      const name = prompt('Nome veicolo:', v.name||'') ?? v.name;
      const plate = prompt('Targa (opzionale):', v.plate||'') ?? v.plate;
      const type = prompt('Tipo (Auto/Mot
